# Руководство по тестированию миграций и системы контроля версий

## Содержание
1. [Введение](#введение)
2. [Подготовка к тестированию](#подготовка-к-тестированию)
3. [Тестирование миграций](#тестирование-миграций)
4. [Тестирование системы контроля версий](#тестирование-системы-контроля-версий)
5. [Автоматизация тестирования](#автоматизация-тестирования)

## Введение

Это руководство описывает процесс тестирования миграций базы данных и системы контроля версий в проекте. Мы используем Alembic для управления миграциями и Git для контроля версий.

## Подготовка к тестированию

### Настройка тестовой базы данных

1. Убедитесь, что PostgreSQL установлен и запущен на вашей системе.

2. Настройте переменные окружения для подключения к PostgreSQL (опционально):
```bash
# Windows (PowerShell)
$env:POSTGRES_USER="postgres"
$env:POSTGRES_PASSWORD="postgres"
$env:POSTGRES_HOST="localhost"
$env:POSTGRES_PORT="5432"

# Windows (Command Prompt)
set POSTGRES_USER=postgres
set POSTGRES_PASSWORD=postgres
set POSTGRES_HOST=localhost
set POSTGRES_PORT=5432

# Linux/MacOS
export POSTGRES_USER=postgres
export POSTGRES_PASSWORD=postgres
export POSTGRES_HOST=localhost
export POSTGRES_PORT=5432
```

3. Создайте тестовую базу данных с помощью скрипта:
```bash
# Из корневой директории проекта
python tests/init_test_db.py
```

Скрипт автоматически:
- Проверит существование базы данных
- Создаст базу данных, если она не существует
- Установит переменную окружения TEST_DATABASE_URL

### Установка зависимостей

1. Создайте и активируйте виртуальное окружение:
```bash
# Windows
python -m venv .venv
.venv\Scripts\activate

# Linux/MacOS
python -m venv .venv
source .venv/bin/activate
```

2. Установите зависимости:
```bash
pip install -r requirements.txt
```

## Тестирование миграций

### Подготовка к тестированию

1. Создайте тестовую базу данных:
```bash
createdb test_db
```

2. Настройте переменные окружения для тестов:
```bash
export TEST_DATABASE_URL=postgresql://user:password@localhost/test_db
```

### Типы тестов миграций

1. **Тесты создания миграций**
   - Проверка корректности создания новых миграций
   - Валидация SQL-запросов
   - Проверка зависимостей между миграциями

2. **Тесты применения миграций**
   - Проверка успешного применения миграций
   - Проверка отката миграций
   - Проверка целостности данных после миграции

3. **Тесты производительности**
   - Измерение времени выполнения миграций
   - Проверка блокировок и конкурентного доступа

### Процесс тестирования

1. **Перед созданием миграции:**
   - Создайте бэкап базы данных
   - Задокументируйте текущее состояние схемы
   - Определите ожидаемые изменения

2. **При создании миграции:**
   - Используйте `alembic revision --autogenerate`
   - Проверьте сгенерированный код
   - Добавьте необходимые проверки и валидации

3. **После создания миграции:**
   - Примените миграцию на тестовой базе
   - Проверьте целостность данных
   - Выполните откат и проверьте восстановление

## Тестирование системы контроля версий

### Основные проверки

1. **Проверка структуры репозитория**
   - Корректность `.gitignore`
   - Наличие необходимых конфигурационных файлов
   - Структура веток

2. **Проверка коммитов**
   - Семантическое версионирование
   - Качество сообщений коммитов
   - Связь с задачами/тикетами

3. **Проверка ветвления**
   - Стратегия ветвления
   - Процесс слияния
   - Разрешение конфликтов

### Процесс тестирования Git

1. **Перед коммитом:**
   - Проверка форматирования кода
   - Запуск линтеров
   - Проверка тестов

2. **При создании ветки:**
   - Следование соглашениям по именованию
   - Создание от соответствующей базовой ветки
   - Документирование цели ветки

3. **При слиянии:**
   - Проверка конфликтов
   - Валидация изменений
   - Обновление документации

## Автоматизация тестирования

### CI/CD пайплайн

1. **Этапы автоматизации:**
   - Автоматический запуск тестов при пуше
   - Проверка миграций в изолированной среде
   - Валидация структуры Git-репозитория

2. **Инструменты:**
   - GitHub Actions / GitLab CI
   - pytest для тестирования
   - pre-commit хуки

### Pre-commit хуки

Настройте следующие pre-commit хуки:
```yaml
repos:
- repo: https://github.com/pre-commit/pre-commit-hooks
  rev: v4.4.0
  hooks:
    - id: trailing-whitespace
    - id: end-of-file-fixer
    - id: check-yaml
    - id: check-added-large-files
    - id: check-ast
    - id: check-json
    - id: check-merge-conflict
    - id: detect-private-key

- repo: https://github.com/psf/black
  rev: 23.3.0
  hooks:
    - id: black

- repo: https://github.com/PyCQA/flake8
  rev: 6.0.0
  hooks:
    - id: flake8
```

## Рекомендации по тестированию

1. **Регулярность:**
   - Запускайте тесты перед каждым коммитом
   - Проверяйте миграции в изолированной среде
   - Регулярно обновляйте тестовые данные

2. **Документация:**
   - Ведите журнал тестирования
   - Документируйте найденные проблемы
   - Обновляйте руководство при изменении процесса

3. **Безопасность:**
   - Не храните чувствительные данные в тестовой базе
   - Используйте отдельные учетные данные для тестов
   - Регулярно очищайте тестовые данные

## Запуск всех тестов
pytest

## Запуск только тестов миграций
pytest -m migration

## Запуск только тестов git
pytest -m git

## Запуск тестов с отчетом о покрытии
pytest --cov 